name: Build and Release

on:
    release:
        types: [published]

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Install dependencies
              run: npm install terser

            - name: Get version from tag or package.json
              id: version
              run: |
                  if [[ "${{ github.ref }}" == refs/tags/* ]]; then
                    VERSION=${GITHUB_REF#refs/tags/}
                    VERSION=${VERSION#v}
                  else
                    VERSION=$(node -e "console.log(require('./package.json').version)")
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Version: $VERSION"

            - name: Update manifest.json with version
              run: |
                  VERSION=${{ steps.version.outputs.version }}
                  echo "Updating manifest with version: $VERSION"
                  node -e "
                    const fs = require('fs');
                    const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
                    manifest.version = '$VERSION';
                    fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
                    console.log('Updated manifest.json to version $VERSION');
                  "

            - name: Minify waa.js
              run: |
                  npx terser waa.js -o waa-min.js -c -m
                  echo "Minified waa.js to waa-min.js"
                  ls -lh waa.js waa-min.js

            - name: Create extension artifact
              run: |
                  mkdir -p dist
                  cp manifest.json dist/
                  cp waa-min.js dist/
                  cp -r icons dist/
                  ls -lh dist/
                  zip -r whatsapp-web-adapter-${{ steps.version.outputs.version }}.xpi dist/*

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: whatsapp-web-adapter-${{ steps.version.outputs.version }}
                  path: dist/
                  retention-days: 90
            - name: Create release on GitHub
              uses: softprops/action-gh-release@v2
              with:
                  files: "*.xpi" # Path to your build artifact
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
